import { Button, Input, Separator } from '@keadex/keadex-ui-kit/cross'
import { extractToOPFS } from '@keadex/keadex-utils'
import { APIs, urlBuilder } from '@keadex/keadex-utils/api'
import { useState } from 'react'
import { useTranslation } from 'react-i18next'
import { useNavigate } from 'react-router-dom'
import { toast } from 'react-toastify'
import GitHubRepoSelector, {
  GitHubRepository,
} from '../../components/GitHubRepoSelector/GitHubRepoSelector'
import SplashScreen from '../../components/SplashScreen/SplashScreen'
import { ENV_SETTINGS } from '../../core/env-settings'
import { HOME_PROJECT } from '../../core/router/routes'
import { useAppDispatch } from '../../core/store/hooks'
import { openProject as openProjectEvent } from '../../core/store/slices/project-slice'
import { openProject } from '../../core/tauri-rust-bridge'
import { extractToFS } from '../../helper/archive-helper'
import { MinaError } from '../../models/autogenerated/MinaError'

/* eslint-disable-next-line */
export interface OpenRemoteProjectProps {}

export const OpenRemoteProject = (props: OpenRemoteProjectProps) => {
  const { t } = useTranslation()
  const dispatch = useAppDispatch()
  const navigate = useNavigate()

  const [isDownloading, setIsDownloading] = useState(false)
  const [projectURL, setProjectURL] = useState('')

  async function extractRepoArchive(
    blobArchive: Blob,
  ): Promise<{ root?: string; dirHandle?: FileSystemDirectoryHandle }> {
    let root
    let dirHandle
    if (ENV_SETTINGS.WEB_MODE) {
      dirHandle = await extractToOPFS(blobArchive)
    } else {
      root = await extractToFS(blobArchive)
    }
    return { root, dirHandle }
  }

  async function downloadProject(url: string, init?: RequestInit) {
    setIsDownloading(true)
    fetch(url, init)
      .then(async (response) => {
        if (response.ok) {
          const blob = await response.blob()
          const rootDirExtracted = await extractRepoArchive(blob)
          setIsDownloading(false)
          openProject(rootDirExtracted.root, rootDirExtracted.dirHandle)
            .then((project) => {
              dispatch(openProjectEvent(project))
              navigate(HOME_PROJECT)
            })
            .catch((error: MinaError) => {
              toast.error(
                t('common.error.project_not_opened', {
                  errorMessage: error.msg,
                }),
              )
            })
        } else {
          setIsDownloading(false)
          toast.error(
            t('common.error.cannot_download_project', {
              errorMessage: response.statusText,
            }),
          )
        }
      })
      .catch((error) => {
        setIsDownloading(false)
        toast.error(
          t('common.error.cannot_download_project', {
            errorMessage: error,
          }),
        )
      })
  }

  async function handleRepoSelected(
    repo: GitHubRepository,
    branch: string,
    token?: string,
  ) {
    if (token) {
      downloadProject(urlBuilder(APIs.KeadexGitHubRepoDownload.path), {
        headers: {
          [APIs.KeadexGitHubRepoDownload.headers.ghToken]: token,
          [APIs.KeadexGitHubRepoDownload.headers.ghRepo]: repo.name,
          [APIs.KeadexGitHubRepoDownload.headers.ghOwner]: repo.owner.login,
          [APIs.KeadexGitHubRepoDownload.headers.ghBranch]: branch,
        },
      })
    }
  }

  return (
    <div className={`w-full h-full p-3`}>
      {/* Splash Screen */}
      {isDownloading && (
        <SplashScreen
          className="!fixed top-0 bottom-0 z-[1] bg-primary/90"
          label={t('remote_diagrams.downloading_project')}
          showLoading
          hideLogo
        />
      )}

      {/* Header */}
      <div
        className={`text-accent-primary inline-block text-2xl font-bold pointer-events-none mt-2`}
      >
        {t('remote_project.title')}
      </div>

      <div className="flex absolute left-3 right-2 top-14 bottom-0">
        {/* From GitHub */}
        <div className="w-1/2 h-full p-2 flex flex-col">
          <div className="text-center mt-14 text-xl text-white">
            {t('remote_project.from_github')}
          </div>
          <div className="mt-14 h-full">
            <GitHubRepoSelector onRepoSelected={handleRepoSelected} />
          </div>
        </div>

        <Separator orientation="vertical" className="h-full" />

        {/* From URL */}
        <div className="w-1/2 p-2 flex flex-col">
          <div className="text-center mt-14 text-xl text-white">
            {t('remote_project.from_url')}
          </div>
          <div className="flex flex-col mt-14 h-full">
            <Input
              classNameRoot="mx-2"
              label={t('remote_diagrams.type_url_mina_project')}
              info={`${t(
                'common.example',
              )}: https://example.com/my-mina-project.zip`}
              value={projectURL}
              onChange={(e) => setProjectURL(e.target.value)}
            />
            <Button
              className="mt-5 w-36 mx-auto"
              onClick={() => downloadProject(projectURL)}
            >
              {t('common.open')}
            </Button>
          </div>
        </div>
      </div>
    </div>
  )
}

export default OpenRemoteProject
