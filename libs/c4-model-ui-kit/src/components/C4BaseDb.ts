import { fabric } from 'fabric'
import { getAutoPosition } from '../helper/diagram-helper'
import { DiagramElementSpec } from '../models/autogenerated/DiagramElementSpec'
import { ElementData } from '../models/autogenerated/ElementData'
import { RenderElementsOptions } from '../rendering-system/diagram-renderer'
import { DB, ELEMENT } from '../styles/style-constants'
import C4BaseBox, { C4BaseBoxOptions } from './C4BaseBox'
import {
  C4BaseComponent,
  C4BaseComponentData,
  C4BaseComponentOptions,
} from './C4BaseComponent'
import { AddElementTag } from '../models/autogenerated/AddElementTag'
import { getCustomTagsStyle, parseTags } from '../helper/tags-helper'

export const C4BaseDb = (
  data: C4BaseComponentData,
  elementSpec: DiagramElementSpec,
  autoLayout: Record<string, ElementData>,
  options: C4BaseComponentOptions,
  renderElementsOptions: RenderElementsOptions | undefined,
): C4BaseComponent => {
  const customTagsStyle = getCustomTagsStyle(
    parseTags(data.base_data?.tags),
    renderElementsOptions?.tags,
  )
  const objects: fabric.Object[] = []

  // ----- Base Box
  const baseBox = createBaseBox(data, options, renderElementsOptions)
  objects.push(baseBox)

  const radiusTopBottomDb =
    (baseBox.width ?? 0) / 2 - ELEMENT.SIZES.BORDER_WIDTH / 2

  // ----- Top Db
  objects.push(
    createTopDb(baseBox, radiusTopBottomDb, options, customTagsStyle),
  )

  // ----- Bottom Db
  objects.push(
    createBottomDb(baseBox, radiusTopBottomDb, options, customTagsStyle),
  )

  const defaults: DiagramElementSpec = {
    alias: data.base_data?.alias,
    position: getAutoPosition(data.base_data?.alias, autoLayout),
  }

  return new C4BaseComponent(data, elementSpec, defaults, autoLayout, objects)
}

const createBaseBox = (
  data: C4BaseComponentData,
  options: C4BaseBoxOptions,
  renderElementsOptions: RenderElementsOptions | undefined,
): fabric.Group => {
  const c4BaseBoxOptions: C4BaseBoxOptions = {
    ...options,
    borderRadius: 0,
  }
  return C4BaseBox(data, {}, {}, c4BaseBoxOptions, renderElementsOptions)
}

const createBottomDb = (
  baseBox: fabric.Group,
  radiusTopBottomDb: number,
  options: C4BaseBoxOptions,
  customTagsStyle: AddElementTag | undefined,
): fabric.Object => {
  return new fabric.Circle({
    fill: customTagsStyle?.bg_color ?? options.bgColor,
    stroke: customTagsStyle?.border_color ?? options.borderColor,
    strokeWidth: ELEMENT.SIZES.BORDER_WIDTH,
    radius: radiusTopBottomDb,
    top:
      (baseBox.top ?? 0) +
      (baseBox.height ?? 0) -
      (radiusTopBottomDb * 2 * DB.SIZES.SCALE_X_TOP_BOTTOM) / 2 -
      ELEMENT.SIZES.BORDER_WIDTH,
    left: (baseBox.left ?? 0) + (baseBox.width ?? 0),
    angle: 90,
    startAngle: 270,
    endAngle: 90,
    scaleX: DB.SIZES.SCALE_X_TOP_BOTTOM,
  })
}

const createTopDb = (
  baseBox: fabric.Group,
  radiusTailHeadQueue: number,
  options: C4BaseBoxOptions,
  customTagsStyle: AddElementTag | undefined,
): fabric.Group => {
  const objects: fabric.Object[] = []

  const marginTopDb = ELEMENT.SIZES.BORDER_WIDTH

  // Empty box
  const heightEmptyBox = DB.SIZES.TOP_BOX_HEIGHT
  const emptyBox = new fabric.Rect({
    fill: customTagsStyle?.bg_color ?? options.bgColor,
    strokeWidth: 0,
    left: (baseBox.left ?? 0) + ELEMENT.SIZES.BORDER_WIDTH,
    top: (baseBox.top ?? 0) - heightEmptyBox + marginTopDb,
    width: (baseBox.width ?? 0) - ELEMENT.SIZES.BORDER_WIDTH * 2,
    height: heightEmptyBox,
  })
  objects.push(emptyBox)

  // Left line
  objects.push(
    new fabric.Line(
      [
        baseBox.left ?? 0,
        baseBox.top ?? 0,
        baseBox.left ?? 0,
        emptyBox.top ?? 0,
      ],
      {
        strokeWidth: ELEMENT.SIZES.BORDER_WIDTH,
        stroke: customTagsStyle?.border_color ?? options.borderColor,
        originX: 'left',
        originY: 'top',
      },
    ),
  )

  // right line
  objects.push(
    new fabric.Line(
      [
        (baseBox.left ?? 0) + (baseBox.width ?? 0) - ELEMENT.SIZES.BORDER_WIDTH,
        baseBox.top ?? 0,
        (baseBox.left ?? 0) + (baseBox.width ?? 0) - ELEMENT.SIZES.BORDER_WIDTH,
        emptyBox.top ?? 0,
      ],
      {
        strokeWidth: ELEMENT.SIZES.BORDER_WIDTH,
        stroke: customTagsStyle?.border_color ?? options.borderColor,
        originX: 'left',
        originY: 'top',
      },
    ),
  )

  // Ellipse
  objects.push(
    new fabric.Circle({
      fill: customTagsStyle?.bg_color ?? options.bgColor,
      stroke: customTagsStyle?.border_color ?? options.borderColor,
      strokeWidth: ELEMENT.SIZES.BORDER_WIDTH,
      radius: radiusTailHeadQueue,
      top:
        (emptyBox.top ?? 0) -
        ((baseBox.width ?? 0) * DB.SIZES.SCALE_X_TOP_BOTTOM) / 2,
      left: (emptyBox.left ?? 0) + +(baseBox.width ?? 0) - marginTopDb,
      angle: 90,
      startAngle: 0,
      endAngle: 360,
      scaleX: DB.SIZES.SCALE_X_TOP_BOTTOM,
    }),
  )

  return new fabric.Group(objects)
}

export default C4BaseDb
