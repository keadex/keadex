import { fabric } from 'fabric'
import { ELEMENT, PERSON } from '../../styles/style-constants'
import { DiagramElementSpec } from '../../models/autogenerated/DiagramElementSpec'
import C4BaseBox from '../C4BaseBox'
import { C4BaseBoxOptions } from '../C4BaseBox'
import { C4BaseComponent } from '../C4BaseComponent'
import { C4BaseComponentOptions, C4BaseComponentData } from '../C4BaseComponent'

export const C4BasePerson = (
  data: C4BaseComponentData,
  elementSpec: DiagramElementSpec,
  options: C4BaseComponentOptions
): C4BaseComponent => {
  const objects: fabric.Object[] = []

  // ----- Trunk
  const trunk = createTrunk(data, options)
  objects.push(trunk)

  // ----- Head
  const head = createHead(options, trunk)
  objects.push(head)

  const defaults: DiagramElementSpec = {
    alias: data.base_data?.alias,
    position: {
      left: ELEMENT.SIZES.DEFAULT_LEFT,
      top: ELEMENT.SIZES.DEFAULT_TOP,
    },
  }

  return new C4BaseComponent(data, elementSpec, defaults, objects)
}

const createTrunk = (
  data: C4BaseComponentData,
  options: C4BaseBoxOptions
): fabric.Group => {
  const c4BaseBoxOptions: C4BaseBoxOptions = {
    ...options,
    borderRadius: PERSON.SIZES.BORDER_RADIUS,
  }
  return C4BaseBox(data, {}, c4BaseBoxOptions)
}

const createHead = (
  options: C4BaseBoxOptions,
  trunk: fabric.Object
): fabric.Circle => {
  const head = new fabric.Circle({
    radius: PERSON.SIZES.HEAD_RADIUS,
    top: trunk.top,
    left: trunk.left,
    fill: options.bgColor,
    stroke: options.borderColor,
    strokeWidth: ELEMENT.SIZES.BORDER_WIDTH,
  })
  head.left =
    (head.left ?? 0) +
    (trunk.getScaledWidth() ?? 0) / 2 -
    (head.getScaledWidth() ?? 0) / 2
  head.top = (head.top ?? 0) - (head.getScaledWidth() ?? 0) + 5
  return head
}

export default C4BasePerson
