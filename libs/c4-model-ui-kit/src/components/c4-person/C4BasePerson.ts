import { fabric } from 'fabric'
import { getAutoPosition } from '../../helper/diagram-helper'
import { DiagramElementSpec } from '../../models/autogenerated/DiagramElementSpec'
import { ElementData } from '../../models/autogenerated/ElementData'
import { RenderElementsOptions } from '../../rendering-system/diagram-renderer'
import { ELEMENT, PERSON } from '../../styles/style-constants'
import C4BaseBox, { C4BaseBoxOptions } from '../C4BaseBox'
import {
  C4BaseComponent,
  C4BaseComponentData,
  C4BaseComponentOptions,
} from '../C4BaseComponent'

export const C4BasePerson = (
  data: C4BaseComponentData,
  elementSpec: DiagramElementSpec,
  autoLayout: Record<string, ElementData>,
  options: C4BaseComponentOptions,
  renderElementsOptions: RenderElementsOptions | undefined,
): C4BaseComponent => {
  const objects: fabric.Object[] = []

  // ----- Trunk
  const trunk = createTrunk(data, options, renderElementsOptions)
  objects.push(trunk)

  // ----- Head
  const head = createHead(options, trunk)
  objects.push(head)

  const defaults: DiagramElementSpec = {
    alias: data.base_data?.alias,
    position: getAutoPosition(data.base_data?.alias, autoLayout),
  }

  return new C4BaseComponent(data, elementSpec, defaults, autoLayout, objects)
}

const createTrunk = (
  data: C4BaseComponentData,
  options: C4BaseBoxOptions,
  renderElementsOptions: RenderElementsOptions | undefined,
): fabric.Group => {
  const c4BaseBoxOptions: C4BaseBoxOptions = {
    ...options,
    borderRadius: PERSON.SIZES.BORDER_RADIUS,
  }
  return C4BaseBox(data, {}, {}, c4BaseBoxOptions, renderElementsOptions)
}

const createHead = (
  options: C4BaseBoxOptions,
  trunk: fabric.Object,
): fabric.Circle => {
  const head = new fabric.Circle({
    radius: PERSON.SIZES.HEAD_RADIUS,
    top: trunk.top,
    left: trunk.left,
    fill: options.bgColor,
    stroke: options.borderColor,
    strokeWidth: ELEMENT.SIZES.BORDER_WIDTH,
  })
  head.left =
    (head.left ?? 0) +
    (trunk.getScaledWidth() ?? 0) / 2 -
    (head.getScaledWidth() ?? 0) / 2
  head.top = (head.top ?? 0) - (head.getScaledWidth() ?? 0) + 5
  return head
}

export default C4BasePerson
