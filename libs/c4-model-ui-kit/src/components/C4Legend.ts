import { fabric } from 'fabric'
import { DiagramElementSpec } from '../models/autogenerated/DiagramElementSpec'
import { LEGEND, BOX, ELEMENT } from '../styles/style-constants'
import { C4BaseComponent } from './C4BaseComponent'

export const ALIAS = 'legend'

export const C4Legend = (elementSpec?: DiagramElementSpec): C4BaseComponent => {
  let objects: fabric.Object[] = []

  const title = createTitle()
  objects.push(title)

  objects = objects.concat(
    createItem(
      'System/Person',
      BOX.COLORS.BG_COLOR_SOFTWARE_SYSTEM_PERSON,
      BOX.COLORS.TEXT_COLOR_SOFTWARE_SYSTEM_PERSON,
      1
    )
  )
  objects = objects.concat(
    createItem(
      'System/Person External',
      BOX.COLORS.BG_COLOR_SOFTWARE_SYSTEM_PERSON_EXT,
      BOX.COLORS.TEXT_COLOR_SOFTWARE_SYSTEM_PERSON_EXT,
      2
    )
  )
  objects = objects.concat(
    createItem(
      'Container',
      BOX.COLORS.BG_COLOR_CONTAINER,
      BOX.COLORS.TEXT_COLOR_CONTAINER,
      3
    )
  )

  objects = objects.concat(
    createItem(
      'Container External',
      BOX.COLORS.BG_COLOR_CONTAINER_EXT,
      BOX.COLORS.TEXT_COLOR_CONTAINER_EXT,
      4
    )
  )

  objects = objects.concat(
    createItem(
      'Component',
      BOX.COLORS.BG_COLOR_COMPONENT,
      BOX.COLORS.TEXT_COLOR_COMPONENT,
      5
    )
  )

  objects = objects.concat(
    createItem(
      'Component External',
      BOX.COLORS.BG_COLOR_COMPONENT_EXT,
      BOX.COLORS.TEXT_COLOR_COMPONENT_EXT,
      6
    )
  )

  const defaults: DiagramElementSpec = {
    alias: ALIAS,
    position: {
      left: LEGEND.SIZES.LEFT,
      top: LEGEND.SIZES.TOP,
    },
  }

  return new C4BaseComponent(undefined, elementSpec, defaults, objects)
}

const createTitle = (): fabric.Object => {
  return new fabric.Text('LEGEND', {
    fill: LEGEND.COLOR.TEXT_COLOR_TITLE,
    fontFamily: ELEMENT.FONT.FAMILY,
    fontSize: LEGEND.FONT.SIZE_TITLE,
    fontWeight: 'bold',
    textAlign: 'left',
    originX: 'left',
    originY: 'top',
    left: LEGEND.SIZES.LEFT,
    top: LEGEND.SIZES.TOP,
  })
}

const createItem = (
  name: string,
  bgColor: string,
  textColor: string,
  position: number
): fabric.Object[] => {
  const objects: fabric.Object[] = []

  const box = new fabric.Rect({
    fill: bgColor,
    left: LEGEND.SIZES.LEFT,
    top: LEGEND.SIZES.TOP + LEGEND.SIZES.HEIGHT * position,
    width: LEGEND.SIZES.WIDTH,
    height: LEGEND.SIZES.HEIGHT,
  })
  objects.push(box)

  const text = new fabric.Text(name, {
    fill: textColor,
    fontFamily: ELEMENT.FONT.FAMILY,
    fontSize: LEGEND.FONT.SIZE_ITEM,
    fontWeight: 'normal',
    textAlign: 'left',
    originX: 'left',
    originY: 'top',
    left: LEGEND.SIZES.LEFT + LEGEND.SIZES.PADDING_LEFT,
  })
  text.top = (box.top ?? 0) + (box.height ?? 0) / 2 - (text.height ?? 0) / 2
  objects.push(text)
  return objects
}

export default C4Legend
